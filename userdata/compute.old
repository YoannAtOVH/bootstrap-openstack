#!/bin/bash

# Setup logging stdout + stderr to logfile
log_file="/var/log/postinstall.log"

function log_handler {
  while IFS='' read -r output; do
    echo $output
    echo "$(date) - $output" >> $log_file
  done
}

exec &> >(log_handler)

dhclient ens4

apt update
apt -y install software-properties-common
add-apt-repository -y cloud-archive:pike
apt -y purge cloud-init
apt -y dist-upgrade
apt -y install chrony crudini lnav avahi-daemon

# Install nova
apt -y install nova-api nova-conductor nova-consoleauth nova-novncproxy nova-scheduler

# Configure nova
crudini --set /etc/nova/nova.conf api_database connection mysql+pymysql://nova:zoblesmouches42@mysql/nova_api
crudini --set /etc/nova/nova.conf database connection mysql+pymysql://nova:zoblesmouches42@mysql/nova
crudini --set /etc/nova/nova.conf DEFAULT transport_url rabbit://openstack:zoblesmouches42@rabbit
crudini --set /etc/nova/nova.conf DEFAULT my_ip 192.168.1.103
crudini --del /etc/nova/nova.conf DEFAULT log_dir
crudini --set /etc/nova/nova.conf keystone_authtoken auth_uri http://keystone:5000
crudini --set /etc/nova/nova.conf keystone_authtoken auth_url http://keystone:35357
crudini --set /etc/nova/nova.conf keystone_authtoken memcached_servers keystone:11211
crudini --set /etc/nova/nova.conf keystone_authtoken auth_type password
crudini --set /etc/nova/nova.conf keystone_authtoken project_domain_name default
crudini --set /etc/nova/nova.conf keystone_authtoken user_domain_name default
crudini --set /etc/nova/nova.conf keystone_authtoken project_name service
crudini --set /etc/nova/nova.conf keystone_authtoken username nova
crudini --set /etc/nova/nova.conf keystone_authtoken password zoblesmouches42
crudini --set /etc/nova/nova.conf vnc enabled True
crudini --set /etc/nova/nova.conf vnc vncserver_listen 192.168.1.103
crudini --set /etc/nova/nova.conf vnc vncserver_proxyclient_address 192.168.1.103
crudini --set /etc/nova/nova.conf glance api_servers http://glance:9292
crudini --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp
crudini --set /etc/nova/nova.conf placement os_region_name RegionOne
crudini --set /etc/nova/nova.conf placement project_domain_name Default
crudini --set /etc/nova/nova.conf placement project_name service
crudini --set /etc/nova/nova.conf placement auth_type password
crudini --set /etc/nova/nova.conf placement user_domain_name Default
crudini --set /etc/nova/nova.conf placement auth_url http://keystone:35357/v3
crudini --set /etc/nova/nova.conf placement username placement
crudini --set /etc/nova/nova.conf placement password zoblesmouches42

su -s /bin/sh -c "nova-manage api_db sync" nova
su -s /bin/sh -c "nova-manage cell_v2 map_cell0" nova
su -s /bin/sh -c "nova-manage cell_v2 create_cell --name=cell1 --verbose" nova
su -s /bin/sh -c "nova-manage db sync" nova

service nova-api restart
service nova-consoleauth restart
service nova-scheduler restart
service nova-conductor restart
service nova-novncproxy restart

